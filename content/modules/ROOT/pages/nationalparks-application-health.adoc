= アプリケーションヘルスチェック
:navtitle: アプリケーションヘルスチェック

include::vars.adoc[]

== 背景: ReadinessプローブとLivenessプローブ
以前、UI の警告で確認したように、OpenShift にはアプリケーションヘルスチェックという概念があります。これには 2 つの種類があります。

* Readinessプローブ
* Livenessプローブ

ドキュメントの
link:{ocp4_starter_openshift_docs}/html/building_applications/application-health[Application
Health,window='_blank'] セクションでは、次のように定義が示されています。

[glossary]
Livenessプローブ::
Livenessプローブは、それが設定されているコンテナがまだ実行中かどうかを確認します。Livenessプローブが失敗した場合、kubelet はコンテナを強制終了し、コンテナは再起動ポリシーに従います。Livenessプローブを設定するには、Pod設定の `template.spec.containers.livenessprobe` スタンザを設定します。
    
Readinessプローブ::
Readinessプローブは、コンテナがリクエストを処理する準備ができているかどうかを判断します。Readinessプローブがコンテナで失敗した場合、エンドポイントコントローラーは、そのコンテナの IP アドレスがすべてのサービスのエンドポイントから削除されていることを確認します。Readinessプローブを使用すると、コンテナが実行中であっても、プロキシからのトラフィックを受信してははならないことをエンドポイントコントローラーに通知できます。
Readinessプローブを設定するには、Pod設定の `template.spec.containers.readinessprobe` スタンザを設定します。

複雑に聞こえますが、実際にはそうではありません。Webコンソールを使用して、これらのプローブを
`nationalparks` アプリケーションに追加します。

[#add_health_checks]
== 演習: ヘルスチェックの追加
現実的なCI/CDパイプラインを実装するため、アプリケーションの「開発」バージョンをテストします。ただし、テストを行うには、アプリケーションが準備完了している必要があります。ここで、OpenShiftのアプリケーションヘルスチェック機能が非常に役立ちます。

既存の `nationalparks` デプロイメントに、ReadinessプローブとLivenessプローブの両方を追加します。これにより、OpenShiftは、Readinessチェックに合格するまでインスタンスをサービスに追加せず、Livenessチェックに不合格となったインスタンスは再起動されます。

*Topology* Viewで `nationalparks` をクリックします。サイドパネルで  *Actions* ドロップダウンメニューをクリックし、*Add Health Checks* を選択します。

[.bordershadow]
image::nationalparks-application-health-menu.png[link="self",window=_blank]

*Add Readiness Probe* をクリックして *Path* フィールドに以下を追加します。 

[source,role=copypaste]
----
/ws/healthz/
----

*Port* 8080 と *Type* HTTP GETなど、すべての設定をデフォルトのままにしておきます。右下の小さな灰色の確認チェックマークをクリックして確定します。

[.bordershadow]
image::nationalparks-application-health-settings.png[link="self",window=_blank]
 
Livenessプローブについても同じ手順を繰り返し、*Add Liveness Probe* をクリックして、*Path* フィールドに追加します。

[source,role=copypaste]
----
/ws/healthz/
----

*Port* 8080 と *Type* HTTP GETなど、すべての設定をデフォルトのままにしておきます。右下の小さな灰色の確認チェックマークをクリックして確定します。

最後に *Add* をクリックしてすべての新しい変更を確定します。

[.bordershadow]
image::nationalparks-application-health-add.png[link="self",window=_blank]

これらの変更により新しいデプロイメントが発生し、設定変更としてカウントされたことがわかります。
