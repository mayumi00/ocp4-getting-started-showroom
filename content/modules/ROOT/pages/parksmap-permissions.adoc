= パーミッション（権限）
:navtitle: Permissions

include::vars.adoc[]

OpenShift 環境とのほぼすべてのやり取りは、OpenShift のコントロールプレーン API を経由する必要があります。すべての API やり取りは、認証 (AuthN - ユーザーは誰ですか?) と認可 (AuthZ - 要求している操作を実行できますか?) の両方が行われます。

ログ出力セクションでは、*Service Account* に関連するエラーを確認しました。

OpenShift は宣言型プラットフォームであるため、一部のアクションはエンドユーザーがコマンドを発行するのではなく、プラットフォームによって実行されます。これらのアクションは、プラットフォームが内部的に使用する特別なタイプの `ユーザー` である *Service Account* を使用して実行されます。

OpenShift は、すべてのプロジェクトにいくつかの特別なService Accountを自動的に作成します。
**default** Service Accountは Pod の実行を担当し、OpenShift は起動されるすべての Pod にこのService Accountを自動的に挿入します。このService Accountの権限を変更することで、追加機能を有効にできます。

Web コンソールで現在の権限を表示するには、link:{ocp4_starter_console_url}/topology/ns/{ocp4_starter_project}[Topology view, link="self",window=_blank] に移動し、`parksmap` エントリをクリックして、*Details* タブに移動し、*Namespace* をクリックします。 

[.bordershadow]
image::parksmap-permissions-namespace.png[link="self",window=_blank]

*Role Bindings* タブを選択し、Filterをクリックし *Namespace Role Binding* でフィルターして、選択したプロジェクトのすべての権限を表示します。

[.bordershadow]
image::parksmap-permissions-membership.png[link="self",window=_blank]

[#grant_serviceaccount_view_permissions]
== 演習: Service Accountに表示(view)権限を付与する
parksmap アプリケーションは、OpenShift API と通信して、プロジェクト内の他の *Pod*、*Services*、およびリソースに関する情報を取得しようとします。その理由はすぐに説明します。

parksmap アプリケーションは、クラスター上のプロジェクト内で *Service Account* として実行されます。つまり、`default` *Service Account* です。この *Service Account* に必要な `view` 権限を付与することで、API をクエリしてプロジェクト内のリソースを確認できるようになります。これにより、ログに表示されたエラーメッセージの原因が解消されます。

`{ocp4_starter_project}` プロジェクトの `default` *Service Account* を更新するには、以下のいずれかのオプション  *OpenShift コンソール* または *`oc` コマンドライン* を選択します。

====
*OPTION A: OpenShiftコンソール:*

. *Home* -> *Projects* -> *{ocp4_starter_project}* に移動し、*Role Bindings* を選択して、*Create Binding* ボタンをクリックします。
+
image::parksmap-permissions-membership-serviceaccount-list.png[link="self",window=_blank]
+
. 次のフィールドを設定します:
  * Role Binding Name: *view*
  * Namespace: *{ocp4_starter_project}*
  * Role Name: *view*
  * Subject: *Service Account*
  * Subject Namespace: *{ocp4_starter_project}*
  * Subject Name: *default*
+
image::parksmap-permissions-membership-serviceaccount-edit.png[link="self",window=_blank]
+
. 権限の編集が完了したら、*Create* ボタンをクリックします。すると、`{ocp4_starter_project}` プロジェクトの *RoleBindings* リストに新しい `view` 項目が表示されるはずです。
+
image::parksmap-permissions-membership-serviceaccount-done.png[link="self",window=_blank]

*OPTION B: `oc` コマンドライン:*

まず、適切なプロジェクト コンテキストにいることを確認します。

[source,role="copypaste",subs="attributes"]
----
oc project {ocp4_starter_project}
----

次に、`oc policy add-role-to-user` コマンドを使用して、定義済みの `view` ロールをservice accountに付与します。

[source,role="copypaste"]
----
oc policy add-role-to-user view -z default
----

.`-z` フラグは何をしますか?
****
`oc policy` の `-h` 出力から:

[source]
----
-z, --serviceaccount=[]: service account in the current namespace to use as a user
----

`-z` 構文は特別なもので、文字列全体（この場合は `system:serviceaccount:{ocp4_starter_project}:default`）を入力する手間を省きます。これは便利なショートカットです。
****

NOTE: `-z` フラグは、 *現在の* プロジェクト内のservice accountに対してのみ機能します。別のプロジェクトのservice accountを参照する場合は、`-n <project>` スイッチを使用してください。
====

[#redeploy_application]
== 演習: アプリケーションの再デプロイ

`oc rollout` コマンドを使用して `parksmap` アプリケーションを再起動します。これにより、新しい Pod が作成されます。

[source,role="copypaste"]
----
oc rollout restart deployment/parksmap
----

新しいデプロイメントがすぐに開始されます。Topology viewに戻り、もう一度 `parksmap` エントリをクリックして、デプロイメントの実行状況を確認してください。デプロイメントはすぐに完了しますが、*ReplicaSet* の数値に変化が反映されているのが確認できます。また、`oc get pods` コマンドを使用して、新しいポッドの年齢がわずか数秒であることも確認できます。

[.bordershadow]
image::parksmap-permissions-redeployed.png[link="self",window=_blank]

アプリケーション ログを確認すると、エラーは表示されません。
