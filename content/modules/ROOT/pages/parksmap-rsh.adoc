= コンテナへの接続
:navtitle: Connecting to a Container

include::vars.adoc[]

コンテナはimmutable(不変)のインフラストラクチャとして扱われるため、SSH 経由でコンテナの内容を変更したり、コンテナ内でカスタムコマンドを実行したりすることは一般的に推奨されません。ただし、アプリケーションのデバッグなど、一部のユースケースでは、コンテナにアクセスしてアプリケーションを検査することが有益な場合があります。

[#remote_shell_to_container_using_cli]
== 演習: CLI を使用したコンテナへのリモートシェルセッション

OpenShift では、各コンテナ内で SSH サービスを実行することなく、コンテナへのリモートシェルセッションを確立できます。コンテナ内で対話型セッションを確立するには、`oc rsh` コマンドを使用します。まず、利用可能な Pod のリストを取得します。

[source,role="copypaste"]
----
oc get pods
----

次のような出力が表示されます。

[.console-output]
[source]
----
NAME                        READY   STATUS    RESTARTS   AGE
parksmap-65c4f8b676-fxcrq   1/1     Running   0          52m
----

これで、Pod 名を使用して Pod へのリモート シェル セッションを確立できます。

[source,role="copypaste"]
----
oc rsh parksmap-65c4f8b676-fxcrq
----

次の出力が表示されます。

[.console-output]
[source]
----
sh-4.2$
----

[NOTE]
====
`oc rsh` が使用するデフォルトのシェルは `/bin/sh` です。デプロイされたコンテナに *sh* がインストールされておらず、別のシェル（例: *bash* ）を使用している場合は、発行するコマンドの Pod 名の後にシェルコマンドを指定できます。
====

ルート ディレクトリ内のファイルを一覧表示するには、次のコマンドを実行します。

[source,role="copypaste"]
----
ls /
----

[.console-output]
[source]
----
anaconda-post.log  bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  parksmap.jar  proc  root  run  sbin  srv  sys  tmp  usr  var
----

先ほど説明したデフォルトのService Accountを覚えていますか? コンテナに挿入されたそのService Accountに関連付けられたトークンは、次のコマンドを使用して表示できます。

[source,role="copypaste"]
----
cat /var/run/secrets/kubernetes.io/serviceaccount/token
----

[#remote_shell_session_to_container_using_webconsole]
== 演習: Web コンソールを使用したコンテナへのリモートシェルセッション

OpenShift Web コンソールは、CLI を使用せずにコンテナのターミナルセッションにアクセスできる便利な方法も提供します。

Web コンソールから Pod のターミナルにアクセスするには、Topology view に移動し、`parksmap` エントリをクリックしてから、*Pod* をクリックします。 

[.bordershadow]
image::parksmap-rsh-dev-console-pod.png[link="self",window=_blank]

選択したPodの情報を表示したら、*Terminal* タブをクリックしてシェル セッションを開きます。

[.bordershadow]
image::parksmap-rsh-applications-pods-terminal.png[link="self",window=_blank]

CLI を使用したときと同じコマンドを実行して、Web コンソールベースのターミナルの動作を確認してください。

続行する前に、Pod への接続を閉じます。

[source,role="copypaste"]
----
exit
----

[#execute_command_in_container]
== 演習: コンテナ内でコマンドを実行する

リモートシェルに加えて、`oc exec` コマンドを使用して、すでに実行中のコンテナ内でコマンドをリモートで実行することも可能です。この場合、シェルのインストールは不要で、必要なコマンドが実行パスに存在することが必要です。

`parksmap` アプリケーションの JAR ファイルのみを表示するには、次のコマンドを実行します。

[source,role="copypaste"]
----
oc exec parksmap-65c4f8b676-fxcrq -- ls -l /parksmap.jar
----

次のような画面が表示されます。

[.console-output]
[source]
----
-rw-r--r--. 1 root root 39138901 Apr  1 16:54 /parksmap.jar
----

[NOTE]
====
`oc exec` コマンドの `--` 構文は、exec のオプションの終了位置と、実際に実行するコマンドの開始位置を示します。詳細については、`oc exec`
`--help` を参照してください。
====

`oc rsh` コマンドを使用して、直接実行するシェル コマンドを指定することもできます。

[source,role="copypaste"]
----
oc rsh parksmap-65c4f8b676-fxcrq whoami
----

次のような画面が表示されます。

[.console-output]
[source]
----
1000580000
----

[NOTE]
====
セキュリティ上の理由から、OpenShift はデフォルトでは Dockerfile で指定されたユーザーでコンテナを実行しないことを理解することが重要です。実際、OpenShift がコンテナを起動する際、そのユーザーはランダムに決定されます。

OpenShift ユーザーが root（または任意のユーザー）として実行されることを想定したコンテナイメージをデプロイできるようにする必要がある場合は、小さな設定変更が必要です。
詳細については、OpenShift の
link:{ocp4_starter_openshift_docs}/html/images/creating-images[container image guidelines,window='_blank'] 
をご覧ください。
====
