= Route（ルート）
:navtitle: ルート

include::vars.adoc[]

このワークショップセクションでは、アプリケーションを外部ユーザーがアクセスできるようにします。

[.bordershadow]
image::roadshow-app-architecture-parksmap-2.png[link="self",window=_blank]

[#routes]
== 背景：Route（ルート）

*Service* はOpenShift環境内で内部抽象化と負荷分散を提供しますが、OpenShiftの**外部**のクライアント（ユーザー、システム、デバイスなど）がアプリケーションにアクセスする必要がある場合があります。外部クライアントは、OpenShiftルーティングレイヤーを介してOpenShiftで実行されているアプリケーションにアクセスします。ルーティングレイヤーは、 *Route* オブジェクトを使用して設定できます。

デフォルトのOpenShiftルーター（ https://www.haproxy.org/[HAProxy, window="_blank"]）は、受信リクエストのHTTPヘッダーを使用して、接続をプロキシする場所を決定します。必要に応じて、*Route*にTLSなどのセキュリティを定義できます。 *Service* 、ひいては *Pod* に外部からアクセスできるようにするには、*Route* を作成する必要があります。

[#creating_a_route]
== 演習: ルートの作成

`parksmap` アプリケーションをデプロイした際に、*Route* を作成するためのチェックボックスをオフにしたことを覚えているかもしれません。通常は自動的に作成されます。幸い、*Route* の作成は簡単なプロセスです。

ルートは、OpenShift コンソールまたは `oc` CLI を使用して作成できます。以下のいずれかのオプションを使用して、ルートを追加する方法を選択してください。

====

*オプション A: OpenShift コンソール:*

. *Networking -> Routes* をクリックし、*Create Route* ボタンをクリックします。
. *Name* フィールドに *parksmap* と入力します。
. *Service* フィールドで *parksmap* を選択します。*Target Port* で *8080* を選択します。
. *Security* セクションで *Secure route* にチェックを入れます。*TLS Termination* リストから「Edge*」を選択します。
. その他のフィールドはすべて空白のままにして、*Create* をクリックします。
+
image::parksmap-route-create-1.png[link="self",window=_blank]

TIP: クラスターアプリドメインのTLS証明書はデフォルトで使用されるため、証明書を追加する必要はありません。OpenShiftクラスターに解決されるカスタムドメインを使用する場合は、ルートごとに証明書を追加できます。

*Route* を作成するときに、*Route* のホスト名やパス、追加の TLS 構成などの他のオプションを指定できます。

*オプション B: `oc` コマンドライン:*

*Service* を `expose` するには、まず既存の *Routes* がないことを確認します。

[source,role="copypaste"]
----
oc get routes
----

[.console-output]
[source]
----
No resources found.
----

次に、公開する *Service* 名を取得する必要があります。

[source,role="copypaste"]
----
oc get services
----

[.console-output]
[source]
----
NAME       CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
parksmap   172.30.169.213   <none>        8080/TCP   5h
----

*Service* の名前がわかれば、*Route* の作成は簡単な 1つのコマンド タスクになります。

[source,role="copypaste"]
----
oc create route edge parksmap --service=parksmap
----

[.console-output]
[source]
----
route.route.openshift.io/parksmap created
----

====

次のコマンドで *Route* が作成されたことを確認します。

[source,role="copypaste"]
----
oc get route
----

[source,role="copypaste",subs="attributes"]
----
NAME       HOST/PORT                                                           PATH   SERVICES   PORT       TERMINATION   WILDCARD
parksmap   parksmap-{ocp4_starter_project}.{ocp4_starter_apps_domain}          parksmap   8080-tcp   edge          None
----

`parksmap` デプロイメントの *Resources* タブの *Topology* ビューでも *Route* を確認できます。Topology の `parksmap` ノードに矢印アイコンが表示されています。これをクリックすると、ブラウザで *Route* の URL が開きます。

[.bordershadow]
image::parksmap-route-created.png[link="self",window=_blank]

アプリケーションは、Developer Perspectiveに表示されているURLで利用できるようになりました。リンクをクリックすると表示されます。

NOTE: このページを初めて開く場合、ブラウザは位置情報の取得許可を求めます。これは、フロントエンドアプリが世界地図をあなたの現在地を中心に表示するために必要なものです。許可しない場合、アプリはデフォルトの位置情報を使用します。

[.bordershadow]
image::parksmap-route-empty-map.png[link="self",window=_blank]
