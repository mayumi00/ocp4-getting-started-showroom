= パイプラインによる自動化
:navtitle: パイプラインによる自動化

include::vars.adoc[]

OpenShift の組み込みコンポーネントに加えて、OpenShift Pipeline は link:https://tekton.dev/docs/triggers/[*Tekton Triggers*,window='_blank'] によりパイプラインに追加のトリガーと自動化を提供します。

[#webhooks]
== 背景: Web フック

ほとんどの Git リポジトリサーバーは、Web フックの概念をサポートしています。Web フックとは、コードリポジトリに変更が発生したときに HTTP(S) 経由で外部ソースを呼び出すことです。
OpenShift は、ビルドをトリガーするためにリモートシステムからフックを受信することをサポートする API エンドポイントを提供しています。コードリポジトリのフックを OpenShift Pipelines リソースに指定することで、自動化されたコード/ビルド/デプロイパイプラインを実現できます。

[#adding_triggers_to_your_pipeline]
== パイプラインへのトリガーの追加

Tekton の *Triggers* を使用すると、Web Hooks などの外部イベント（Git プッシュイベント、プルリクエストなど）に応答するようにパイプラインを設定できます。

トリガーサポートを追加するには、プロジェクトに `TriggerTemplate`、`TriggerBinding`、および `EventListener` を作成する必要があります。


[.bordershadow]
image::devops-pipeline-triggers.png[link="self",window=_blank]


各コンポーネントの詳細を見てみましょう。

* *TriggerTemplate*: トリガーテンプレートは、新規に作成されるリソースのテンプレートです。特定の `PipelineResources` と `PipelineRuns` を作成するためのパラメータをサポートしています。
* *TriggerBinding*: イベントを検証し、ペイロードフィールドを抽出します。
* *EventListener*: `TriggerBindings` と `TriggerTemplates` をアドレス指定可能なエンドポイント（イベントシンク）に接続します。各 TriggerBinding から抽出されたイベントパラメータ（および指定された静的パラメータ）を使用して、対応する TriggerTemplate で指定されたリソースを作成します。また、オプションで、インターセプターフィールドを介して外部サービスがイベントペイロードを前処理できるようにすることもできます。


それでは、パイプライン用にこれらすべてをまとめて作成してみましょう。

// Depending on which language you chose, you can use the following YAML files:

// ====
// *Java*

[source,role="copypaste",subs="attributes"]
----
oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks/raw/branch/master/pipeline/nationalparks-triggers.yaml -n {ocp4_starter_project}
----

// *.NET*

// [source,role="copypaste",subs="attributes"]
// ----
// oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks-dotnet/master/Pipelines/nationalparks-triggers-all.yaml -n {ocp4_starter_project}
// ----

// *Javascript*:

// [source,role="copypaste",subs="attributes"]
// ----
// oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks-js/master/pipelines/nationalparks-triggers-all.yaml -n {ocp4_starter_project}
// ----

// *Python*

// [source,role="copypaste",subs="attributes"]
// ----
// oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks-py/master/pipelines/nationalparks-triggers-all.yaml -n {ocp4_starter_project}
// ----
// ====

これにより、GitHub 上で Webhook を設定し、パイプラインの自動起動をトリガーできるルートを持つ新しい Pod が作成されます。

*Topology* Viewで `EventListener` 用の新しい デプロイメント *el-nationalparks* が作成されていることを確認します。

[.bordershadow]
image::devops-pipeline-triggers-eventlistener.png[width=500,link="self",window=_blank]

[#configuring_webhooks]
== 演習: Gitea Webhook の設定

このセクションでは、ビルド Webhook を使用して、nationalparks Gitea リポジトリに変更があるたびにパイプラインの実行をトリガーします。

URL をクリップボードにコピーしたら、Gitea 上のコードリポジトリに移動します。

link:{ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks[Gitea Repository,window='_blank']

画面右上のボタンからサインインしてください。

Gitea の認証情報は次のとおりです。

[source,subs=attributes]
----
username: {ocp4_starter_gitea_user}
password: {ocp4_starter_gitea_password}
----

画面の右上にある Settings リンクをクリックします。

[.bordershadow]
image::nationalparks-codechanges-settings.png[link="self",window=_blank]

*Webhooks* をクリックし、次に *Add Webhook* ボタンをクリックし、最後に *Gitea* を選択します。


[.bordershadow]
image::nationalparks-codechanges-add-webhook.png[link="self",window=_blank]

前のセクションで作成した EventListener を使用して、Gitea で Webhook を設定します。
`EventListener` には、Webhook の URL として使用する OpenShift の `Route` が公開されています。

[source,role=copypaste,subs=attributes]
----
http://el-nationalparks-{ocp4_starter_project}.{ocp4_starter_apps_domain}/
----

"Payload URL"欄にリンクを貼り付けます。

`Content Type` を `application/json` に変更します。

最後に、*Update Webhook* をクリックします。



[.bordershadow]
image::nationalparks-codechanges-config-webhook.png[link="self",window=_blank]

やった！これからは、Giteaリポジトリに新しいソースコードをコミットするたびに、
OpenShift内で新しいビルドとデプロイが実行されるようになります。
試してみましょう。

[#using_webhooks]
== 演習: Gitea Web Hooksの使用

次に、Gitea を使ってファイルを編集し、変更をコミットしてプッシュします。

link:{ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks/src/branch/master/src/main/java/com/openshift/evg/roadshow/parks/rest[located here in the gitea repository,window='_blank']にある `BackendController.java` ファイルを開きましょう。

ブラウザにコピー＆ペーストする場合の URL は以下のとおりです。

[source,role="copypaste",subs="attributes"]
----
{ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks/src/branch/master/src/main/java/com/openshift/evg/roadshow/parks/rest
----

ファイルが画面に表示されたら、右上隅にある編集ボタンをクリックします。

image::nationalparks-codechanges-change-code.png[Webhook]

20行目を変更します。

[source]
----
return new Backend("nationalparks","National Parks", new Coordinates("47.039304", "14.505178"), 4);
----

これを以下に変更します。

[source,role="copypaste"]
----
return new Backend("nationalparks","Amazing National Parks", new Coordinates("47.039304", "14.505178"), 4);
----

画面下部の「変更をコミット」をクリックします。コミットメッセージは自由に入力してください。

変更をコミットすると、新しい *PipelineRun* が自動的にトリガーされるはずです。

前の演習で PipelineRun を確認しました。これは新しい *Build* を作成し、アプリケーションを OpenShift にデプロイします。確認してみましょう。

*Topology* Viewで `nationalparks` をクリックし、*Resources* タブの *Builds* セクションを確認するか、以下のコマンドを実行して確認します。

[source,role="copypaste"]
----
oc get builds
----

新しいビルドが実行されていることがわかります。

[.console-output]
[source]
----
NAME              TYPE      FROM          STATUS     STARTED          DURATION
nationalparks-1   Source    Git@b052ae6   Complete   18 hours ago     36s
nationalparks-2   Source    Git@3b26e1a   Running    43 seconds ago
----

ビルドとデプロイが完了したら、ブラウザでアプリケーションを表示して、新しいイメージが自動的にデプロイされたことを確認します。

link:http://nationalparks-{ocp4_starter_project}.{ocp4_starter_apps_domain}/ws/info/[National Parks Info Page,window='_blank']

返されるJSON文字列に、設定した新しい名前が表示されるはずです。

NOTE: マップの凡例自体にこれを表示するには、parksmap を 0 に縮小してから 1 に戻して、アプリのキャッシュを強制的に更新する必要があります。
